const ApiResponse = require('../utils/apiResponse');
const catchAsync = require('../utils/catchAsync');
const EmailService = require('../services/email.service');
const RestaurantModel = require('../models/restaurant.model');

class EmailController {
    
    static sendReport = catchAsync(async (req, res) => {
        const { restaurantId } = req.user;
        const { reportType, dateRange } = req.body;
        const file = req.file;

        if (!file) {
            throw new Error('No report file uploaded.');
        }

        // 1. Fetch Restaurant Details for this specific user/restaurant
        const restaurant = await RestaurantModel.findById(restaurantId);
        
        if (!restaurant) {
             throw new Error('Restaurant not found.');
        }

        if (!restaurant.ca_email) {
            return ApiResponse.error(res, 'CA Email not configured for this restaurant. Please update settings.', 400);
        }

        // 2. Prepare Email Content
        const subject = `${restaurant.name} - ${reportType === 'orders' ? 'Orders Report' : 'Sales Report'} (${dateRange})`;
        
        const htmlBody = `
            <div style="font-family: 'Helvetica/Arial', sans-serif; color: #333; max-width: 600px; margin: 0 auto; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                <!-- Header -->
                <div style="background-color: #1a1a1a; padding: 20px; text-align: center;">
                    <h1 style="color: #ffffff; margin: 0; font-size: 24px; font-weight: 300;">${restaurant.name}</h1>
                    <p style="color: #aaaaaa; margin: 5px 0 0; font-size: 14px;">${restaurant.address || ''}</p>
                </div>

                <!-- Body -->
                <div style="padding: 30px; background-color: #ffffff;">
                    <h2 style="color: #333; font-size: 20px; margin-top: 0;">Hi CA,</h2>
                    <p style="line-height: 1.6; color: #555;">
                        Please find attached the <strong>${reportType === 'orders' ? 'Orders Data (Excel)' : 'Sales Report (PDF)'}</strong> for the period: <strong>${dateRange}</strong>.
                    </p>

                    <div style="background-color: #f9f9f9; padding: 15px; border-radius: 6px; margin: 20px 0; border-left: 4px solid #3366cc;">
                        <h3 style="margin: 0 0 10px; font-size: 16px; color: #333;">Restaurant Details</h3>
                        <p style="margin: 5px 0; font-size: 14px;"><strong>GSTIN:</strong> ${restaurant.gstin || 'N/A'}</p>
                        <p style="margin: 5px 0; font-size: 14px;"><strong>Owner/Contact:</strong> ${restaurant.contact_number || 'N/A'}</p>
                        <p style="margin: 5px 0; font-size: 14px;"><strong>Email:</strong> ${restaurant.contact_email || 'N/A'}</p>
                    </div>

                    <p style="line-height: 1.6; color: #555;">
                        This is an automated report generated from the <strong>MuchMate Dashboard</strong>.
                    </p>
                </div>

                <!-- Footer -->
                <div style="background-color: #f4f4f4; padding: 15px; text-align: center; font-size: 12px; color: #888;">
                    &copy; ${new Date().getFullYear()} ${restaurant.name}. All rights reserved.<br>
                    Generated by MuchMate POS
                </div>
            </div>
        `;

        // 3. Send Email
        await EmailService.sendReportEmail(
            restaurant.ca_email, 
            subject, 
            htmlBody, 
            [{
                filename: file.originalname,
                content: file.buffer,
                contentType: file.mimetype
            }]
        );

        return ApiResponse.success(res, null, `Report sent successfully to ${restaurant.ca_email}`);
    });
}

module.exports = EmailController;
